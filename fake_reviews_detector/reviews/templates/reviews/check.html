{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î–µ—Ç–µ–∫—Ç–æ—Ä —Ñ–µ–π–∫–æ–≤—ã—Ö –æ—Ç–∑—ã–≤–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .loader {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result-card {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease-out;
        }
        
        .show-result {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="d-flex align-items-center">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card p-4">
                    <h2 class="text-center mb-4">üîç –ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å</h2>
                    
                    <form id="reviewForm" class="mb-4">
                        {% csrf_token %}
                        <div class="form-group">
                            <textarea 
                                class="form-control" 
                                name="text" 
                                rows="4" 
                                placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞..."
                                required
                            ></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-3">
                            –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </form>
                    
                    <div class="text-center">
                        <div class="loader mx-auto"></div>
                    </div>
                    
                    <div id="resultContainer" class="result-card"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#reviewForm').submit(function(e) {
                e.preventDefault();
                $('.loader').show();
                $('#resultContainer').empty().removeClass('show-result');
                
                $.ajax({
                    type: 'POST',
                    url: '{% url "check" %}',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.result_id) {
                            checkResult(response.result_id);
                        } else if (response.error) {
                            showError(response.error);
                        }
                    },
                    error: function() {
                        showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                    }
                });
            });
            
            function checkResult(resultId) {
                const checkInterval = setInterval(function() {
                    $.get(`/api/results/${resultId}/`, function(data) {
                        if (data.status === 'complete') {
                            clearInterval(checkInterval);
                            showResult(data);
                        } else if (data.status === 'pending') {
                            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å
                        }
                    });
                }, 2000);
            }
            
            function showResult(data) {
                const resultClass = data.is_fake ? 'alert-danger' : 'alert-success';
                const resultHTML = `
                    <div class="alert ${resultClass} show-result p-4">
                        <h4 class="alert-heading">${data.is_fake ? '‚ö†Ô∏è –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤!' : '‚úÖ –û—Ç–∑—ã–≤ –ø–æ—Ö–æ–∂ –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∏–π'}</h4>
                        <hr>
                        <p class="mb-1"><strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ñ–µ–π–∫–∞:</strong> ${(data.probability * 100).toFixed(1)}%</p>
                        <p class="mb-0"><strong>–ê–Ω–∞–ª–∏–∑:</strong> ${data.details.model}</p>
                    </div>
                `;
                
                $('.loader').hide();
                $('#resultContainer')
                    .html(resultHTML)
                    .addClass('show-result');
            }
            
            function showError(message) {
                $('.loader').hide();
                $('#resultContainer')
                    .html(`<div class="alert alert-warning show-result">${message}</div>`)
                    .addClass('show-result');
            }
        });
    </script>
    <script>
    $(document).ready(function() {
        $('#reviewForm').on('submit', function(e) {
            e.preventDefault();
            $('.loader').show();
            $('#resultContainer').empty().removeClass('show-result');
            
            $.ajax({
                type: 'POST',
                url: "{% url 'check' %}",
                data: $(this).serialize(),
                success: function(response) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ Celery
                    const checkTaskStatus = setInterval(() => {
                        $.get(`/api/task-status/${response.task_id}/`, (task_result) => {
                            if (task_result.status === 'SUCCESS') {
                                clearInterval(checkTaskStatus);
                                // –¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ –ë–î
                                $.get(`/api/results/${response.review_id}/`, (analysis) => {
                                    showAnalysisResult(analysis);
                                });
                            } else if (task_result.status === 'FAILURE') {
                                clearInterval(checkTaskStatus);
                                $('#resultContainer').html(
                                    '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞</div>'
                                ).addClass('show-result');
                            }
                        });
                    }, 1000);
                },
                error: function(xhr) {
                    $('#resultContainer').html(
                        `<div class="alert alert-danger">–û—à–∏–±–∫–∞: ${xhr.responseJSON?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`
                    ).addClass('show-result');
                    $('.loader').hide();
                }
            });
        });
    
        function showAnalysisResult(result) {
            const fakeClass = result.is_fake ? 'alert-danger' : 'alert-success';
            const fakeText = result.is_fake ? '–§–µ–π–∫–æ–≤—ã–π' : '–ù–∞—Å—Ç–æ—è—â–∏–π';
            
            $('#resultContainer').html(`
                <div class="alert ${fakeClass} mt-3">
                    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:</h4>
                    <p>–°—Ç–∞—Ç—É—Å: <strong>${fakeText}</strong></p>
                    <p>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: ${(result.probability * 100).toFixed(2)}%</p>
                </div>
            `).addClass('show-result');
            $('.loader').hide();
        }
    });
    </script>
</body>
</html>